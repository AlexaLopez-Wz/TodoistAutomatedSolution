"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
const SharedErrors = __importStar(require("../../../../../../shared/errors"));
const EXECUTION_CTX_WAS_DESTROYED_CODE = -32000;
const SELECTOR_MAX_EXECUTE_COUNT = 10;
const PROXYLESS_SCRIPT = 'window["%proxyless%"]';
class ClientFunctionExecutor {
    constructor() {
        // new Map<frameId, executionContextId>
        this._frameExecutionContexts = new Map();
        this._currentFrameId = '';
    }
    async evaluateScript(Runtime, expression) {
        const script = { expression, awaitPromise: true };
        if (this._currentFrameId && this._frameExecutionContexts.has(this._currentFrameId))
            script.contextId = this._frameExecutionContexts.get(this._currentFrameId);
        try {
            const { result, exceptionDetails = null } = await Runtime.evaluate(script);
            return { result, exceptionDetails, error: null };
        }
        catch (error) {
            return { result: null, exceptionDetails: null, error };
        }
    }
    async _evaluateScriptWithReloadPageIgnore(Runtime, expression) {
        let attempts = 0;
        let result;
        let exceptionDetails;
        let error;
        while (attempts++ < SELECTOR_MAX_EXECUTE_COUNT) {
            ({ result, exceptionDetails, error } = await this.evaluateScript(Runtime, expression));
            if (error && error.response.code === EXECUTION_CTX_WAS_DESTROYED_CODE)
                continue;
            break;
        }
        // eslint-disable-next-line @typescript-eslint/no-object-literal-type-assertion
        return { result, exceptionDetails, error };
    }
    static _getPropertyByName(properties, name) {
        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
        return properties.find(prop => prop.name === name).value;
    }
    static _throwException(details, command, callsite) {
        var _a;
        const exception = details.exception;
        if (exception) {
            const className = exception.className;
            const properties = (_a = exception.preview) === null || _a === void 0 ? void 0 : _a.properties;
            if (className === SharedErrors.UncaughtErrorInCustomDOMPropertyCode.name) {
                throw new SharedErrors.UncaughtErrorInCustomDOMPropertyCode(command.instantiationCallsiteName, ClientFunctionExecutor._getPropertyByName(properties, 'errMsg'), ClientFunctionExecutor._getPropertyByName(properties, 'property'), callsite);
            }
            else if (className === SharedErrors.CannotObtainInfoForElementSpecifiedBySelectorError.name) {
                throw new SharedErrors.CannotObtainInfoForElementSpecifiedBySelectorError(callsite, {
                    apiFnChain: command.apiFnChain,
                    apiFnIndex: parseInt(ClientFunctionExecutor._getPropertyByName(properties, 'apiFnIndex'), 10),
                });
            }
            else if (className === SharedErrors.ActionElementNotFoundError.name) {
                throw new SharedErrors.ActionElementNotFoundError(callsite, {
                    apiFnChain: command.apiFnChain,
                    apiFnIndex: parseInt(ClientFunctionExecutor._getPropertyByName(properties, 'apiFnIndex'), 10),
                });
            }
            else if (className === SharedErrors.DomNodeClientFunctionResultError.name)
                throw new SharedErrors.DomNodeClientFunctionResultError(command.instantiationCallsiteName, callsite);
            else if (className === SharedErrors.InvalidSelectorResultError.name)
                throw new SharedErrors.InvalidSelectorResultError(callsite);
            else if (className === SharedErrors.ActionElementIsInvisibleError.name)
                throw new SharedErrors.ActionElementIsInvisibleError(callsite);
        }
        throw new SharedErrors.UncaughtErrorInClientFunctionCode(command.instantiationCallsiteName, details.text, callsite);
    }
    async executeClientFunction(Runtime, command, callsite) {
        const expression = `${PROXYLESS_SCRIPT}.executeClientFunctionCommand(${JSON.stringify(command)});`;
        const { result, exceptionDetails, error } = await this.evaluateScript(Runtime, expression);
        if (error) {
            if (error.response.code === EXECUTION_CTX_WAS_DESTROYED_CODE)
                throw new SharedErrors.ClientFunctionExecutionInterruptionError(command.instantiationCallsiteName, callsite);
            throw error;
        }
        if (exceptionDetails)
            ClientFunctionExecutor._throwException(exceptionDetails, command, callsite);
        return JSON.parse(result.value); // eslint-disable-line @typescript-eslint/no-non-null-assertion
    }
    async executeSelector(args) {
        const { Runtime, command, callsite, selectorTimeout, errTypes } = args;
        const returnNodeObjId = 'DOM' in args;
        const expression = `${PROXYLESS_SCRIPT}.executeSelectorCommand(${JSON.stringify(command)}, ${selectorTimeout}, ${Date.now()},
                                 ${returnNodeObjId}, ${JSON.stringify(errTypes)});`;
        const { result, exceptionDetails, error } = await this._evaluateScriptWithReloadPageIgnore(Runtime, expression);
        if (error)
            throw error;
        if (exceptionDetails)
            ClientFunctionExecutor._throwException(exceptionDetails, command, callsite);
        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
        return returnNodeObjId ? result.objectId : JSON.parse(result.value);
    }
    async getNode(args) {
        const objectId = await this.executeSelector(args);
        const response = await args.DOM.describeNode({ objectId });
        return response.node;
    }
    setupFramesWatching(Runtime) {
        Runtime.on('executionContextCreated', (event) => {
            var _a;
            if (!((_a = event.context.auxData) === null || _a === void 0 ? void 0 : _a.frameId))
                return;
            this._frameExecutionContexts.set(event.context.auxData.frameId, event.context.id);
        });
        Runtime.on('executionContextDestroyed', (event) => {
            for (const [frameId, executionContextId] of this._frameExecutionContexts.entries()) {
                if (executionContextId === event.executionContextId)
                    this._frameExecutionContexts.delete(frameId);
            }
        });
        Runtime.on('executionContextsCleared', () => {
            this._currentFrameId = '';
            this._frameExecutionContexts.clear();
        });
    }
    setCurrentFrameId(frameId) {
        this._currentFrameId = frameId;
    }
}
exports.default = ClientFunctionExecutor;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50LWZ1bmN0aW9uLWV4ZWN1dG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2Jyb3dzZXIvcHJvdmlkZXIvYnVpbHQtaW4vZGVkaWNhdGVkL2Nocm9tZS9jZHAtY2xpZW50L2NsaWVudC1mdW5jdGlvbi1leGVjdXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFZQSw4RUFBZ0U7QUFtQ2hFLE1BQU0sZ0NBQWdDLEdBQUcsQ0FBQyxLQUFLLENBQUM7QUFDaEQsTUFBTSwwQkFBMEIsR0FBUyxFQUFFLENBQUM7QUFDNUMsTUFBTSxnQkFBZ0IsR0FBbUIsdUJBQXVCLENBQUM7QUFHakUsTUFBcUIsc0JBQXNCO0lBQTNDO1FBQ0ksdUNBQXVDO1FBQ3RCLDRCQUF1QixHQUFHLElBQUksR0FBRyxFQUFrQixDQUFDO1FBQzdELG9CQUFlLEdBQVcsRUFBRSxDQUFDO0lBa0p6QyxDQUFDO0lBaEpVLEtBQUssQ0FBQyxjQUFjLENBQUUsT0FBbUIsRUFBRSxVQUFrQjtRQUNoRSxNQUFNLE1BQU0sR0FBb0IsRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLElBQUksRUFBRSxDQUFDO1FBRW5FLElBQUksSUFBSSxDQUFDLGVBQWUsSUFBSSxJQUFJLENBQUMsdUJBQXVCLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUM7WUFDOUUsTUFBTSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsdUJBQXVCLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUU5RSxJQUFJO1lBQ0EsTUFBTSxFQUFFLE1BQU0sRUFBRSxnQkFBZ0IsR0FBRyxJQUFJLEVBQUUsR0FBRyxNQUFNLE9BQU8sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFM0UsT0FBTyxFQUFFLE1BQU0sRUFBRSxnQkFBZ0IsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLENB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QUMseUJBQXlCLEVBQUUsQ0FBQyxLQUFtQyxFQUFFLEVBQUU7O1lBQzFFLElBQUksUUFBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sMENBQUUsT0FBTyxDQUFBO2dCQUMvQixPQUFPO1lBRVgsSUFBSSxDQUFDLHVCQUF1QixDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN0RixDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sQ0FBQyxFQUFFLENBQUMsMkJBQTJCLEVBQUUsQ0FBQyxLQUFxQyxFQUFFLEVBQUU7WUFDOUUsS0FBSyxNQUFNLENBQUMsT0FBTyxFQUFFLGtCQUFrQixDQUFDLElBQUksSUFBSSxDQUFDLHVCQUF1QixDQUFDLE9BQU8sRUFBRSxFQUFFO2dCQUNoRixJQUFJLGtCQUFrQixLQUFLLEtBQUssQ0FBQyxrQkFBa0I7b0JBQy9DLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7YUFDcEQ7UUFDTCxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sQ0FBQyxFQUFFLENBQUMsMEJBQTBCLEVBQUUsR0FBRyxFQUFFO1lBQ3hDLElBQUksQ0FBQyxlQUFlLEdBQUcsRUFBRSxDQUFDO1lBQzFCLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUN6QyxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFTSxpQkFBaUIsQ0FBRSxPQUFlO1FBQ3JDLElBQUksQ0FBQyxlQUFlLEdBQUcsT0FBTyxDQUFDO0lBQ25DLENBQUM7Q0FDSjtBQXJKRCx5Q0FxSkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUHJvdG9jb2wgZnJvbSAnZGV2dG9vbHMtcHJvdG9jb2wnO1xuaW1wb3J0IHsgQ2FsbHNpdGVSZWNvcmQgfSBmcm9tICdjYWxsc2l0ZS1yZWNvcmQnO1xuaW1wb3J0IFByb3RvY29sUHJveHlBcGkgZnJvbSAnZGV2dG9vbHMtcHJvdG9jb2wvdHlwZXMvcHJvdG9jb2wtcHJveHktYXBpJztcbmltcG9ydCBSdW50aW1lQXBpID0gUHJvdG9jb2xQcm94eUFwaS5SdW50aW1lQXBpO1xuaW1wb3J0IEV2YWx1YXRlUmVxdWVzdCA9IFByb3RvY29sLlJ1bnRpbWUuRXZhbHVhdGVSZXF1ZXN0O1xuaW1wb3J0IFJlbW90ZU9iamVjdCA9IFByb3RvY29sLlJ1bnRpbWUuUmVtb3RlT2JqZWN0O1xuaW1wb3J0IEV4Y2VwdGlvbkRldGFpbHMgPSBQcm90b2NvbC5SdW50aW1lLkV4Y2VwdGlvbkRldGFpbHM7XG5pbXBvcnQgUHJvcGVydHlQcmV2aWV3ID0gUHJvdG9jb2wuUnVudGltZS5Qcm9wZXJ0eVByZXZpZXc7XG5pbXBvcnQgRE9NQXBpID0gUHJvdG9jb2xQcm94eUFwaS5ET01BcGk7XG5pbXBvcnQgRXhlY3V0aW9uQ29udGV4dENyZWF0ZWRFdmVudCA9IFByb3RvY29sLlJ1bnRpbWUuRXhlY3V0aW9uQ29udGV4dENyZWF0ZWRFdmVudDtcbmltcG9ydCBFeGVjdXRpb25Db250ZXh0RGVzdHJveWVkRXZlbnQgPSBQcm90b2NvbC5SdW50aW1lLkV4ZWN1dGlvbkNvbnRleHREZXN0cm95ZWRFdmVudDtcbmltcG9ydCBET00gPSBQcm90b2NvbC5ET007XG5pbXBvcnQgKiBhcyBTaGFyZWRFcnJvcnMgZnJvbSAnLi4vLi4vLi4vLi4vLi4vLi4vc2hhcmVkL2Vycm9ycyc7XG5pbXBvcnQge1xuICAgIEV4ZWN1dGVDbGllbnRGdW5jdGlvbkNvbW1hbmQsXG4gICAgRXhlY3V0ZUNsaWVudEZ1bmN0aW9uQ29tbWFuZEJhc2UsXG4gICAgRXhlY3V0ZVNlbGVjdG9yQ29tbWFuZCxcbn0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vLi4vdGVzdC1ydW4vY29tbWFuZHMvb2JzZXJ2YXRpb24nO1xuXG5cbmludGVyZmFjZSBFdmFsdWF0aW9uRXJyb3IgZXh0ZW5kcyBFcnJvciB7XG4gICAgcmVxdWVzdDogRXZhbHVhdGVSZXF1ZXN0O1xuICAgIHJlc3BvbnNlOiB7IGNvZGU6IG51bWJlciB9O1xufVxuXG5pbnRlcmZhY2UgRXZhbHVhdGVTY3JpcHRSZXN1bHQge1xuICAgIHJlc3VsdDogUmVtb3RlT2JqZWN0IHwgbnVsbDtcbiAgICBleGNlcHRpb25EZXRhaWxzOiBFeGNlcHRpb25EZXRhaWxzIHwgbnVsbDtcbiAgICBlcnJvcjogRXZhbHVhdGlvbkVycm9yIHwgbnVsbDtcbn1cblxuaW50ZXJmYWNlIFNlbGVjdG9yU25hcHNob3RBcmdzIHtcbiAgICBSdW50aW1lOiBSdW50aW1lQXBpO1xuICAgIGNvbW1hbmQ6IEV4ZWN1dGVTZWxlY3RvckNvbW1hbmQ7XG4gICAgY2FsbHNpdGU6IENhbGxzaXRlUmVjb3JkO1xuICAgIHNlbGVjdG9yVGltZW91dDogbnVtYmVyO1xuICAgIGVyclR5cGVzOiB7XG4gICAgICAgIG5vdEZvdW5kOiBzdHJpbmc7XG4gICAgICAgIGludmlzaWJsZTogc3RyaW5nO1xuICAgIH07XG59XG5cbmludGVyZmFjZSBTZWxlY3Rvck5vZGVBcmdzIGV4dGVuZHMgU2VsZWN0b3JTbmFwc2hvdEFyZ3Mge1xuICAgIERPTTogRE9NQXBpO1xufVxuXG5cbmNvbnN0IEVYRUNVVElPTl9DVFhfV0FTX0RFU1RST1lFRF9DT0RFID0gLTMyMDAwO1xuY29uc3QgU0VMRUNUT1JfTUFYX0VYRUNVVEVfQ09VTlQgICAgICAgPSAxMDtcbmNvbnN0IFBST1hZTEVTU19TQ1JJUFQgICAgICAgICAgICAgICAgID0gJ3dpbmRvd1tcIiVwcm94eWxlc3MlXCJdJztcblxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDbGllbnRGdW5jdGlvbkV4ZWN1dG9yIHtcbiAgICAvLyBuZXcgTWFwPGZyYW1lSWQsIGV4ZWN1dGlvbkNvbnRleHRJZD5cbiAgICBwcml2YXRlIHJlYWRvbmx5IF9mcmFtZUV4ZWN1dGlvbkNvbnRleHRzID0gbmV3IE1hcDxzdHJpbmcsIG51bWJlcj4oKTtcbiAgICBwcml2YXRlIF9jdXJyZW50RnJhbWVJZDogc3RyaW5nID0gJyc7XG5cbiAgICBwdWJsaWMgYXN5bmMgZXZhbHVhdGVTY3JpcHQgKFJ1bnRpbWU6IFJ1bnRpbWVBcGksIGV4cHJlc3Npb246IHN0cmluZyk6IFByb21pc2U8RXZhbHVhdGVTY3JpcHRSZXN1bHQ+IHtcbiAgICAgICAgY29uc3Qgc2NyaXB0OiBFdmFsdWF0ZVJlcXVlc3QgPSB7IGV4cHJlc3Npb24sIGF3YWl0UHJvbWlzZTogdHJ1ZSB9O1xuXG4gICAgICAgIGlmICh0aGlzLl9jdXJyZW50RnJhbWVJZCAmJiB0aGlzLl9mcmFtZUV4ZWN1dGlvbkNvbnRleHRzLmhhcyh0aGlzLl9jdXJyZW50RnJhbWVJZCkpXG4gICAgICAgICAgICBzY3JpcHQuY29udGV4dElkID0gdGhpcy5fZnJhbWVFeGVjdXRpb25Db250ZXh0cy5nZXQodGhpcy5fY3VycmVudEZyYW1lSWQpO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCB7IHJlc3VsdCwgZXhjZXB0aW9uRGV0YWlscyA9IG51bGwgfSA9IGF3YWl0IFJ1bnRpbWUuZXZhbHVhdGUoc2NyaXB0KTtcblxuICAgICAgICAgICAgcmV0dXJuIHsgcmVzdWx0LCBleGNlcHRpb25EZXRhaWxzLCBlcnJvcjogbnVsbCB9O1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgcmV0dXJuIHsgcmVzdWx0OiBudWxsLCBleGNlcHRpb25EZXRhaWxzOiBudWxsLCBlcnJvciB9O1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBfZXZhbHVhdGVTY3JpcHRXaXRoUmVsb2FkUGFnZUlnbm9yZSAoUnVudGltZTogUnVudGltZUFwaSwgZXhwcmVzc2lvbjogc3RyaW5nKTogUHJvbWlzZTxFdmFsdWF0ZVNjcmlwdFJlc3VsdD4ge1xuICAgICAgICBsZXQgYXR0ZW1wdHMgPSAwO1xuICAgICAgICBsZXQgcmVzdWx0O1xuICAgICAgICBsZXQgZXhjZXB0aW9uRGV0YWlscztcbiAgICAgICAgbGV0IGVycm9yO1xuXG4gICAgICAgIHdoaWxlIChhdHRlbXB0cysrIDwgU0VMRUNUT1JfTUFYX0VYRUNVVEVfQ09VTlQpIHtcbiAgICAgICAgICAgICh7IHJlc3VsdCwgZXhjZXB0aW9uRGV0YWlscywgZXJyb3IgfSA9IGF3YWl0IHRoaXMuZXZhbHVhdGVTY3JpcHQoUnVudGltZSwgZXhwcmVzc2lvbikpO1xuXG4gICAgICAgICAgICBpZiAoZXJyb3IgJiYgZXJyb3IucmVzcG9uc2UuY29kZSA9PT0gRVhFQ1VUSU9OX0NUWF9XQVNfREVTVFJPWUVEX0NPREUpXG4gICAgICAgICAgICAgICAgY29udGludWU7XG5cbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1vYmplY3QtbGl0ZXJhbC10eXBlLWFzc2VydGlvblxuICAgICAgICByZXR1cm4geyByZXN1bHQsIGV4Y2VwdGlvbkRldGFpbHMsIGVycm9yIH0gYXMgRXZhbHVhdGVTY3JpcHRSZXN1bHQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgX2dldFByb3BlcnR5QnlOYW1lIChwcm9wZXJ0aWVzOiBQcm9wZXJ0eVByZXZpZXdbXSwgbmFtZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICAgICAgcmV0dXJuIHByb3BlcnRpZXMuZmluZChwcm9wID0+IHByb3AubmFtZSA9PT0gbmFtZSkhLnZhbHVlITtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBfdGhyb3dFeGNlcHRpb24gKGRldGFpbHM6IEV4Y2VwdGlvbkRldGFpbHMsIGNvbW1hbmQ6IEV4ZWN1dGVDbGllbnRGdW5jdGlvbkNvbW1hbmRCYXNlLCBjYWxsc2l0ZTogQ2FsbHNpdGVSZWNvcmQpOiBuZXZlciB7XG4gICAgICAgIGNvbnN0IGV4Y2VwdGlvbiA9IGRldGFpbHMuZXhjZXB0aW9uO1xuXG4gICAgICAgIGlmIChleGNlcHRpb24pIHtcbiAgICAgICAgICAgIGNvbnN0IGNsYXNzTmFtZSAgPSBleGNlcHRpb24uY2xhc3NOYW1lO1xuICAgICAgICAgICAgY29uc3QgcHJvcGVydGllcyA9IGV4Y2VwdGlvbi5wcmV2aWV3Py5wcm9wZXJ0aWVzIGFzIFByb3BlcnR5UHJldmlld1tdO1xuXG4gICAgICAgICAgICBpZiAoY2xhc3NOYW1lID09PSBTaGFyZWRFcnJvcnMuVW5jYXVnaHRFcnJvckluQ3VzdG9tRE9NUHJvcGVydHlDb2RlLm5hbWUpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgU2hhcmVkRXJyb3JzLlVuY2F1Z2h0RXJyb3JJbkN1c3RvbURPTVByb3BlcnR5Q29kZShjb21tYW5kLmluc3RhbnRpYXRpb25DYWxsc2l0ZU5hbWUsXG4gICAgICAgICAgICAgICAgICAgIENsaWVudEZ1bmN0aW9uRXhlY3V0b3IuX2dldFByb3BlcnR5QnlOYW1lKHByb3BlcnRpZXMsICdlcnJNc2cnKSxcbiAgICAgICAgICAgICAgICAgICAgQ2xpZW50RnVuY3Rpb25FeGVjdXRvci5fZ2V0UHJvcGVydHlCeU5hbWUocHJvcGVydGllcywgJ3Byb3BlcnR5JyksXG4gICAgICAgICAgICAgICAgICAgIGNhbGxzaXRlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYgKGNsYXNzTmFtZSA9PT0gU2hhcmVkRXJyb3JzLkNhbm5vdE9idGFpbkluZm9Gb3JFbGVtZW50U3BlY2lmaWVkQnlTZWxlY3RvckVycm9yLm5hbWUpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgU2hhcmVkRXJyb3JzLkNhbm5vdE9idGFpbkluZm9Gb3JFbGVtZW50U3BlY2lmaWVkQnlTZWxlY3RvckVycm9yKGNhbGxzaXRlLCB7XG4gICAgICAgICAgICAgICAgICAgIGFwaUZuQ2hhaW46IGNvbW1hbmQuYXBpRm5DaGFpbixcbiAgICAgICAgICAgICAgICAgICAgYXBpRm5JbmRleDogcGFyc2VJbnQoQ2xpZW50RnVuY3Rpb25FeGVjdXRvci5fZ2V0UHJvcGVydHlCeU5hbWUocHJvcGVydGllcywgJ2FwaUZuSW5kZXgnKSwgMTApLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoY2xhc3NOYW1lID09PSBTaGFyZWRFcnJvcnMuQWN0aW9uRWxlbWVudE5vdEZvdW5kRXJyb3IubmFtZSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBTaGFyZWRFcnJvcnMuQWN0aW9uRWxlbWVudE5vdEZvdW5kRXJyb3IoY2FsbHNpdGUsIHtcbiAgICAgICAgICAgICAgICAgICAgYXBpRm5DaGFpbjogY29tbWFuZC5hcGlGbkNoYWluLFxuICAgICAgICAgICAgICAgICAgICBhcGlGbkluZGV4OiBwYXJzZUludChDbGllbnRGdW5jdGlvbkV4ZWN1dG9yLl9nZXRQcm9wZXJ0eUJ5TmFtZShwcm9wZXJ0aWVzLCAnYXBpRm5JbmRleCcpLCAxMCksXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChjbGFzc05hbWUgPT09IFNoYXJlZEVycm9ycy5Eb21Ob2RlQ2xpZW50RnVuY3Rpb25SZXN1bHRFcnJvci5uYW1lKVxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBTaGFyZWRFcnJvcnMuRG9tTm9kZUNsaWVudEZ1bmN0aW9uUmVzdWx0RXJyb3IoY29tbWFuZC5pbnN0YW50aWF0aW9uQ2FsbHNpdGVOYW1lLCBjYWxsc2l0ZSk7XG4gICAgICAgICAgICBlbHNlIGlmIChjbGFzc05hbWUgPT09IFNoYXJlZEVycm9ycy5JbnZhbGlkU2VsZWN0b3JSZXN1bHRFcnJvci5uYW1lKVxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBTaGFyZWRFcnJvcnMuSW52YWxpZFNlbGVjdG9yUmVzdWx0RXJyb3IoY2FsbHNpdGUpO1xuICAgICAgICAgICAgZWxzZSBpZiAoY2xhc3NOYW1lID09PSBTaGFyZWRFcnJvcnMuQWN0aW9uRWxlbWVudElzSW52aXNpYmxlRXJyb3IubmFtZSlcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgU2hhcmVkRXJyb3JzLkFjdGlvbkVsZW1lbnRJc0ludmlzaWJsZUVycm9yKGNhbGxzaXRlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRocm93IG5ldyBTaGFyZWRFcnJvcnMuVW5jYXVnaHRFcnJvckluQ2xpZW50RnVuY3Rpb25Db2RlKGNvbW1hbmQuaW5zdGFudGlhdGlvbkNhbGxzaXRlTmFtZSwgZGV0YWlscy50ZXh0LCBjYWxsc2l0ZSk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGV4ZWN1dGVDbGllbnRGdW5jdGlvbiAoUnVudGltZTogUnVudGltZUFwaSwgY29tbWFuZDogRXhlY3V0ZUNsaWVudEZ1bmN0aW9uQ29tbWFuZCwgY2FsbHNpdGU6IENhbGxzaXRlUmVjb3JkKTogUHJvbWlzZTxvYmplY3Q+IHtcbiAgICAgICAgY29uc3QgZXhwcmVzc2lvbiA9IGAke1BST1hZTEVTU19TQ1JJUFR9LmV4ZWN1dGVDbGllbnRGdW5jdGlvbkNvbW1hbmQoJHtKU09OLnN0cmluZ2lmeShjb21tYW5kKX0pO2A7XG5cbiAgICAgICAgY29uc3QgeyByZXN1bHQsIGV4Y2VwdGlvbkRldGFpbHMsIGVycm9yIH0gPSBhd2FpdCB0aGlzLmV2YWx1YXRlU2NyaXB0KFJ1bnRpbWUsIGV4cHJlc3Npb24pO1xuXG4gICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgICAgaWYgKGVycm9yLnJlc3BvbnNlLmNvZGUgPT09IEVYRUNVVElPTl9DVFhfV0FTX0RFU1RST1lFRF9DT0RFKVxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBTaGFyZWRFcnJvcnMuQ2xpZW50RnVuY3Rpb25FeGVjdXRpb25JbnRlcnJ1cHRpb25FcnJvcihjb21tYW5kLmluc3RhbnRpYXRpb25DYWxsc2l0ZU5hbWUsIGNhbGxzaXRlKTtcblxuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZXhjZXB0aW9uRGV0YWlscylcbiAgICAgICAgICAgIENsaWVudEZ1bmN0aW9uRXhlY3V0b3IuX3Rocm93RXhjZXB0aW9uKGV4Y2VwdGlvbkRldGFpbHMsIGNvbW1hbmQsIGNhbGxzaXRlKTtcblxuICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShyZXN1bHQhLnZhbHVlKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGV4ZWN1dGVTZWxlY3RvciA8VCBleHRlbmRzIFNlbGVjdG9yU25hcHNob3RBcmdzIHwgU2VsZWN0b3JOb2RlQXJncz4gKGFyZ3M6IFQpOiBQcm9taXNlPFQgZXh0ZW5kcyBTZWxlY3Rvck5vZGVBcmdzID8gc3RyaW5nIDogb2JqZWN0PiB7XG4gICAgICAgIGNvbnN0IHsgUnVudGltZSwgY29tbWFuZCwgY2FsbHNpdGUsIHNlbGVjdG9yVGltZW91dCwgZXJyVHlwZXMgfSA9IGFyZ3M7XG5cbiAgICAgICAgY29uc3QgcmV0dXJuTm9kZU9iaklkID0gJ0RPTScgaW4gYXJncztcbiAgICAgICAgY29uc3QgZXhwcmVzc2lvbiAgICAgID0gYCR7UFJPWFlMRVNTX1NDUklQVH0uZXhlY3V0ZVNlbGVjdG9yQ29tbWFuZCgke0pTT04uc3RyaW5naWZ5KGNvbW1hbmQpfSwgJHtzZWxlY3RvclRpbWVvdXR9LCAke0RhdGUubm93KCl9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHtyZXR1cm5Ob2RlT2JqSWR9LCAke0pTT04uc3RyaW5naWZ5KGVyclR5cGVzKX0pO2A7XG5cbiAgICAgICAgY29uc3QgeyByZXN1bHQsIGV4Y2VwdGlvbkRldGFpbHMsIGVycm9yIH0gPSBhd2FpdCB0aGlzLl9ldmFsdWF0ZVNjcmlwdFdpdGhSZWxvYWRQYWdlSWdub3JlKFJ1bnRpbWUsIGV4cHJlc3Npb24pO1xuXG4gICAgICAgIGlmIChlcnJvcilcbiAgICAgICAgICAgIHRocm93IGVycm9yO1xuXG4gICAgICAgIGlmIChleGNlcHRpb25EZXRhaWxzKVxuICAgICAgICAgICAgQ2xpZW50RnVuY3Rpb25FeGVjdXRvci5fdGhyb3dFeGNlcHRpb24oZXhjZXB0aW9uRGV0YWlscywgY29tbWFuZCwgY2FsbHNpdGUpO1xuXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gICAgICAgIHJldHVybiByZXR1cm5Ob2RlT2JqSWQgPyByZXN1bHQhLm9iamVjdElkIDogSlNPTi5wYXJzZShyZXN1bHQhLnZhbHVlKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgZ2V0Tm9kZSAoYXJnczogU2VsZWN0b3JOb2RlQXJncyk6IFByb21pc2U8RE9NLk5vZGU+IHtcbiAgICAgICAgY29uc3Qgb2JqZWN0SWQgPSBhd2FpdCB0aGlzLmV4ZWN1dGVTZWxlY3RvcihhcmdzKTtcbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBhcmdzLkRPTS5kZXNjcmliZU5vZGUoeyBvYmplY3RJZCB9KTtcblxuICAgICAgICByZXR1cm4gcmVzcG9uc2Uubm9kZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0dXBGcmFtZXNXYXRjaGluZyAoUnVudGltZTogUnVudGltZUFwaSk6IHZvaWQge1xuICAgICAgICBSdW50aW1lLm9uKCdleGVjdXRpb25Db250ZXh0Q3JlYXRlZCcsIChldmVudDogRXhlY3V0aW9uQ29udGV4dENyZWF0ZWRFdmVudCkgPT4ge1xuICAgICAgICAgICAgaWYgKCFldmVudC5jb250ZXh0LmF1eERhdGE/LmZyYW1lSWQpXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgICAgICB0aGlzLl9mcmFtZUV4ZWN1dGlvbkNvbnRleHRzLnNldChldmVudC5jb250ZXh0LmF1eERhdGEuZnJhbWVJZCwgZXZlbnQuY29udGV4dC5pZCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIFJ1bnRpbWUub24oJ2V4ZWN1dGlvbkNvbnRleHREZXN0cm95ZWQnLCAoZXZlbnQ6IEV4ZWN1dGlvbkNvbnRleHREZXN0cm95ZWRFdmVudCkgPT4ge1xuICAgICAgICAgICAgZm9yIChjb25zdCBbZnJhbWVJZCwgZXhlY3V0aW9uQ29udGV4dElkXSBvZiB0aGlzLl9mcmFtZUV4ZWN1dGlvbkNvbnRleHRzLmVudHJpZXMoKSkge1xuICAgICAgICAgICAgICAgIGlmIChleGVjdXRpb25Db250ZXh0SWQgPT09IGV2ZW50LmV4ZWN1dGlvbkNvbnRleHRJZClcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZnJhbWVFeGVjdXRpb25Db250ZXh0cy5kZWxldGUoZnJhbWVJZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIFJ1bnRpbWUub24oJ2V4ZWN1dGlvbkNvbnRleHRzQ2xlYXJlZCcsICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnRGcmFtZUlkID0gJyc7XG4gICAgICAgICAgICB0aGlzLl9mcmFtZUV4ZWN1dGlvbkNvbnRleHRzLmNsZWFyKCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZXRDdXJyZW50RnJhbWVJZCAoZnJhbWVJZDogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIHRoaXMuX2N1cnJlbnRGcmFtZUlkID0gZnJhbWVJZDtcbiAgICB9XG59XG4iXX0=